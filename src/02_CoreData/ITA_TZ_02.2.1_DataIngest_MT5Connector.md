ITA_TZ_02.2.1_DataIngest_MT5Connector.md

–ü–æ–¥–º–æ–¥—É–ª—å: 2.2.1 Data Ingest (MT5 Connector)
–ú–æ–¥—É–ª—å: 02_CoreData (Core Data & IO)
–ü—Ä–æ–µ–∫—Ç: Intelligent Trading Agent (ITA)
–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É Python-–∫–æ–¥–∞
–î–∞—Ç–∞: 2025-11-06
–í–µ—Ä—Å–∏—è: v1.1
–ê–≤—Ç–æ—Ä—ã: Dreyk (–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏), GPT-5 (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä)

1. üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥–º–æ–¥—É–ª—è

Data Ingest (MT5 Connector) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞–¥—ë–∂–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MetaTrader5 API –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ç–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (OHLCV / tick) –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞.
–û–Ω —è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º—É ITA –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏—Ö –ø–µ—Ä–µ–¥–∞—á—É –≤ –ø–æ–¥–º–æ–¥—É–ª–∏ Data Processor, Session Engine –∏ MT5 Cache

ITA_TZ_02_CoreData

ITA_modules

.

–ó–∞–¥–∞—á–∞ –ø–æ–¥–º–æ–¥—É–ª—è ‚Äî —Å–æ–±—Ä–∞—Ç—å, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –ø—Ä–∏–≥–æ–¥–Ω–æ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Prefect Flow.

2. üì° –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É MT5-—Ç–µ—Ä–º–∏–Ω–∞–ª—É —á–µ—Ä–µ–∑ Python API.

–ü–æ–ª—É—á–µ–Ω–∏–µ OHLCV-–±–∞—Ä–æ–≤ –∏ —Ç–∏–∫–æ–≤ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º:

get_ohlcv(symbol, timeframe, start, end) -> pd.DataFrame


–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ pandas.DataFrame:

–ö–æ–ª–æ–Ω–∫–∏: ["time","open","high","low","close","volume"]

–í—Å–µ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî UTC, tz-aware

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:

–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ / NaN

—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

–µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç datetime (datetime64[ns, UTC])

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ data/archive/raw/{symbol}/{tf}/.

–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Üí fallback –∫ CSV/Archive Loader.

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç—É—Å–∞ –≤ Prefect Flow.

3. üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ

–ü–æ–¥–º–æ–¥—É–ª—å 2.2.1 —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –Ω–∞—á–∞–ª–µ —Ü–µ–ø–æ—á–∫–∏ CoreData:

SetupManager ‚Üí Data Engine ‚Üí MT5 Connector ‚Üí CSV Loader ‚Üí Data Processor ‚Üí Session Engine ‚Üí Cache


–û–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Prefect Task –∏–∑ Data Engine, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–µ—Ä–≤–∏—á–Ω—ã–π DataFrame, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –ø–æ —Ü–µ–ø–æ—á–∫–µ

ITA_TZ_02_CoreData

.

4. ‚öôÔ∏è –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
–ü–∞—Ä–∞–º–µ—Ç—Ä	–¢–∏–ø	–û–ø–∏—Å–∞–Ω–∏–µ
symbol	str	–¢–æ—Ä–≥–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚ÄúEURUSD‚Äù, ‚ÄúGER40‚Äù).
timeframe	str	–¢–∞–π–º—Ñ—Ä–µ–π–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚ÄúM1‚Äù, ‚ÄúM5‚Äù, ‚ÄúH1‚Äù).
start	datetime	–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞.
end	datetime	–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞.
mode	str	‚Äúlive‚Äù –∏–ª–∏ ‚Äúbacktest‚Äù.
incremental	bool	–ü–æ–¥–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –±–∞—Ä–æ–≤ (True) –∏–ª–∏ –ø–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (False).
5. üì§ –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
–§–æ—Ä–º–∞—Ç	–û–ø–∏—Å–∞–Ω–∏–µ
pandas.DataFrame	–û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.
Path	–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π parquet-—Ñ–∞–π–ª –≤ data/archive/raw/....
dict	JSON-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å–∏–º–≤–æ–ª, –ø–µ—Ä–∏–æ–¥, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ä–æ–≤, timestamp –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).

–ü—Ä–∏–º–µ—Ä JSON-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:

{
  "symbol": "EURUSD",
  "timeframe": "M15",
  "bars": 5000,
  "last_timestamp": "2025-11-06T12:00:00Z",
  "source": "MT5"
}

6. üß† –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (Prefect Task Flow)
```
+------------------+
| MT5 Connector    |
+------------------+
         |
         v
  if connection OK:
      load data ‚Üí validate ‚Üí save parquet ‚Üí return DF
  else:
      log warning ‚Üí call CSV Loader
```

–ü—Å–µ–≤–¥–æ–∫–æ–¥:
```
@task
def mt5_connector(symbol, timeframe, start, end, mode="live"):
    try:
        mt5.initialize()
        rates = mt5.copy_rates_range(symbol, timeframe, start, end)
        df = pd.DataFrame(rates)
        df["time"] = pd.to_datetime(df["time"], unit="s", utc=True)
        df.dropna(inplace=True)
        save_parquet(df, symbol, timeframe, start, end)
        return df
    except Exception as e:
        logger.warning(f"MT5 error: {e}")
        return csv_loader(symbol, timeframe, start, end)
```
7. üß∞ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç	–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
MT5 API	MetaTrader5.initialize(), copy_rates_range()
Prefect	Task orchestration, retries, logging
Data Processor	–ø–æ–ª—É—á–∞–µ—Ç DataFrame
MT5 Cache	–ø–æ–ª—É—á–∞–µ—Ç –∫–æ–ø–∏—é –¥–ª—è in-memory —Ö—Ä–∞–Ω–µ–Ω–∏—è
Config –ø–æ–ª—É—á–∞–µ—Ç runtime-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç SetupManager —á–µ—Ä–µ–∑ DataEngine
(symbol, timeframe, date_range).
config.yaml –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
Logging	loguru (JSON lines)
8. üßÆ –ú–µ—Ç–æ–¥—ã –∏ –∫–ª–∞—Å—Å—ã
–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å
```
class MT5Connector:
    def __init__(self, config):
        self.host = config["coredata"]["mt5"]["host"]
        self.port = config["coredata"]["mt5"]["port"]

    def connect(self):
        mt5.initialize()

    def get_ohlcv(self, symbol, timeframe, start, end) -> pd.DataFrame:
        rates = mt5.copy_rates_range(symbol, timeframe, start, end)
        df = pd.DataFrame(rates)
        df["time"] = pd.to_datetime(df["time"], unit="s", utc=True)
        df = df.sort_values("time").dropna()
        return df
```
9. üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ fallback-–º–µ—Ö–∞–Ω–∏–∑–º
–û—à–∏–±–∫–∞	–ü—Ä–∏—á–∏–Ω–∞	–û–±—Ä–∞–±–æ—Ç–∫–∞
ConnectionError	MT5 API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç	–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + fallback –∫ CSV Loader
EmptyDataError	–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ	–≤–æ–∑–≤—Ä–∞—Ç None
ValueError	–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã	–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ retry
FileIOError	–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ parquet	–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
10. üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–ú–µ—Ç—Ä–∏–∫–∞	–¶–µ–ª—å	–ü—Ä–æ–≤–µ—Ä–∫–∞
–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API	‚â§ 0.8 —Å–µ–∫	Prefect logs
–£—Å–ø–µ—à–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Live	‚â• 99%	Scheduler stats
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ NaN	100%	Validator report
–§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫	UTC	DataFrame dtype
11. üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
```
data/
‚îú‚îÄ‚îÄ archive/
‚îÇ   ‚îî‚îÄ‚îÄ raw/
‚îÇ       ‚îî‚îÄ‚îÄ EURUSD/
‚îÇ           ‚îî‚îÄ‚îÄ M15/
‚îÇ               ‚îú‚îÄ‚îÄ 2025_01_01_2025_11_01.parquet
‚îÇ
‚îî‚îÄ‚îÄ cache/
    ‚îî‚îÄ‚îÄ EURUSD_M15_last.parquet
```
12. üîÅ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫—ç—à–µ–º

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∑–∫–∏, MT5 Connector —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞:

IncrementalUpdater.update_cache(symbol, timeframe, df)


–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –±–∞—Ä–æ–≤ –≤ –ø–∞–º—è—Ç–∏ (ring buffer)

ITA_TZ_02_CoreData

.

13. üß© –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
```
–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ (loguru ‚Üí JSON Lines):

{
  "task": "MT5Connector",
  "symbol": "EURUSD",
  "records": 5000,
  "duration": "0.68s",
  "status": "success"
}

```
–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ /logs/coredata/mt5_connector.log.

–ü–µ—Ä–µ–¥–∞—á–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞   
–ú–æ–¥—É–ª—å MT5Connector –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–∞–Ω–Ω—ã—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.  
–î–∏–∞–ø–∞–∑–æ–Ω (date_from, date_to), —Ç–æ—Ä–≥–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (symbol) –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º (timeframe)  
–ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –Ω–µ–≥–æ –∏–∑ SetupManager —á–µ—Ä–µ–∑ CoreData.DataEngine.  

–§–∞–π–ª config.yaml –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ  
–∏ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü –≤ production.  

14. üß† –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç MT5 GUI ‚Äî —á–µ—Ä–µ–∑ API.

‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç DF ‚Üí —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Validator, Market Tools.

‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Live –∏ Backtest —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

‚úÖ Fallback –Ω–∞ CSV –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.

üìò –ò—Ç–æ–≥

Data Ingest (MT5 Connector) ‚Äî –Ω–∞–¥—ë–∂–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º—É ITA.
–û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä—ã–Ω–æ—á–Ω—ã–º –¥–∞–Ω–Ω—ã–º, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ—Ç–∏—Ä–æ–≤–æ–∫.
–ü–æ–¥–º–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π Prefect 2.19, CoreData –∏ DataStorage

