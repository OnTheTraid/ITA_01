
# ITA_TZ_02.2.1_DataIngest_MT5Connector_v1.3

**–¢–∏–ø:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–¢–ó)  
**–ú–æ–¥—É–ª—å:** 02_CoreData  
**–ü–æ–¥–º–æ–¥—É–ª—å:** 2.2.1 Data Ingest (MT5Connector)  
**–í–µ—Ä—Å–∏—è:** 1.3 (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è)  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-10  

---

## 1. üéØ –¶–µ–ª—å –ø–æ–¥–º–æ–¥—É–ª—è

–û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ç–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (OHLCV, ticks) –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ MetaTrader5 —á–µ—Ä–µ–∑ Python API, 
—Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å SetupManager, Prefect FlowController –∏ Market Tools.

–ú–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã **CoreData**, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–±–æ—Ä –∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## 2. üì° –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É MT5-—Ç–µ—Ä–º–∏–Ω–∞–ª—É —á–µ—Ä–µ–∑ Python API (`MetaTrader5`).
2. –ü–æ–ª—É—á–µ–Ω–∏–µ OHLCV-–±–∞—Ä–æ–≤ –∏ —Ç–∏–∫–æ–≤ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º:
   ```python
   get_ohlcv(symbol, timeframe, start, end) -> pd.DataFrame
   ```
3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ `pandas.DataFrame` —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
   ```text
   ["time", "open", "high", "low", "close", "volume"]
   ```
4. –í—Å–µ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ UTC (`datetime64[ns, UTC]`).
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:
   - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏ NaN;
   - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏;
   - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç datetime.
6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ `/data/archive/raw/{symbol}/{tf}/` –≤ —Ñ–æ—Ä–º–∞—Ç–µ Parquet.
7. –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî fallback –∫ **CSV/Archive Loader**.
8. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
9. –í–æ–∑–≤—Ä–∞—Ç JSON-–æ—Ç—á—ë—Ç–∞ –æ —Å—Ç–∞—Ç—É—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ Prefect Flow.

---

## 3. ‚öôÔ∏è –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 3.1 SetupContext JSON (–æ—Ç SetupManager)
```json
{
  "symbol": "GER40",
  "timeframe": "M15",
  "date_start": "2025-04-01",
  "date_end": "2025-05-31",
  "mode": "BACKTEST",
  "prefect_context_id": "run-001"
}
```

### 3.2 ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```
MT5_LOGIN=XXXXXXX
MT5_PASSWORD=XXXXXXX
MT5_SERVER=MetaQuotes-Demo
```

### 3.3 Prefect Task Trigger
- Task –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å ID –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
- Flow ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

---

## 4. üì§ –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

1. DataFrame OHLCV (pandas)
2. –ê—Ä—Ö–∏–≤–Ω—ã–π —Ñ–∞–π–ª:  
   `data/archive/raw/{symbol}/{tf}/{YYYY_MM_DD}_{YYYY_MM_DD}.parquet`
3. JSON-–æ—Ç—á—ë—Ç Prefect:
   ```json
   {
     "context_id": "run-001",
     "status": "SUCCESS",
     "rows": 34560,
     "path": "data/archive/raw/GER40_M15_2025-04-01_2025-05-31.parquet",
     "integrity": "ok"
   }
   ```

---

## 5. üîÅ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ SetupContext JSON.  
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ —á–µ—Ä–µ–∑ `data_cache_manager`.  
   - –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω —É–∂–µ –ø–æ–∫—Ä—ã—Ç –∞—Ä—Ö–∏–≤–æ–º ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.  
   - –ò–Ω–∞—á–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ MT5.  
3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MetaTrader5 API:
   ```python
   if not MT5.initialize(login, password, server):
       raise ConnectionError("MT5 initialization failed")
   ```
4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
   ```python
   rates = MT5.copy_rates_range(symbol, timeframe, start, end)
   df = pd.DataFrame(rates)
   df["time"] = pd.to_datetime(df["time"], unit="s", utc=True)
   ```
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:
   - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ NaN;
   - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–≥–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã;
   - –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–∞–ø—Ä–æ—Å–æ–º.
6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∞—Ä—Ö–∏–≤ (Parquet) –∏ JSON –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
7. –ü–µ—Ä–µ–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ Prefect Flow:
   ```python
   prefect_context.report(
       status="SUCCESS",
       path=output_path,
       rows=len(df),
       integrity="ok"
   )
   ```

---

## 6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|-----------|-----------|
| –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç | `start ‚â§ end` |
| –ü–æ–∫—Ä—ã—Ç–∏–µ –∫—ç—à–µ–º | –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `data_cache_manager` |
| –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ | –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä—ã–≤–æ–≤ –∏ NaN |
| –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ | —Å—Ç—Ä–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∞—è –ø–æ `time` |
| –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö | –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ |
| UTC-–º–µ—Ç–∫–∏ | tz-aware, `datetime64[ns, UTC]` |

---

## 7. üß† –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prefect Flow

- –ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ `@task(prefect)`.
- –ü–µ—Ä–µ–¥–∞—ë—Ç JSON –æ—Ç—á—ë—Ç –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã.
- –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ ‚Äî —Å—Ç–∞—Ç—É—Å `FAILED` –∏ traceback –≤ –æ—Ç—á—ë—Ç–µ Prefect.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è `context_id` –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –≤–Ω—É—Ç—Ä–∏ Flow.

---

## 8. üîÑ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

| –†–µ–∂–∏–º | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|-----------|------------|
| BACKTEST | MetaQuotes-Demo / –∞—Ä—Ö–∏–≤ | –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö |
| LIVE | –¢–æ—Ä–≥–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª | –ü–æ—Ç–æ–∫–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ |

–†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è heartbeat (ping-check –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏ –≤ —Ä–µ–∂–∏–º–µ LIVE.

---

## 9. üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `loguru`, —Ñ–æ—Ä–º–∞—Ç:
```
[CONFIG] - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
[CACHE] - —Ä–∞–±–æ—Ç–∞ —Å –∞—Ä—Ö–∏–≤–∞–º–∏ –∏ –∫–µ—à–µ–º
[MT5] - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º
[CHECK] - –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
[ARCHIVE] - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
[PREFECT] - —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
```

---

## 10. ‚ö†Ô∏è –û—à–∏–±–∫–∏ –∏ fallback

- –í —Ä–µ–∂–∏–º–µ DEBUG —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –∫ CSV loader.
- –í —Ä–∞–±–æ—á–µ–º —Ä–µ–∂–∏–º–µ –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∑–∞–¥–∞—á—É (`raise CriticalError`).
- –í—Å–µ –æ—à–∏–±–∫–∏ –ø–∏—à—É—Ç—Å—è –≤ –ª–æ–≥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ JSON –æ—Ç—á—ë—Ç–µ Prefect.

---

## 11. üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ —ç–º—É–ª—è—Ç–æ—Ä SetupManager (—Å–∫—Ä–∏–ø—Ç `test_mt5connector_emulator.py`):
1. –§–æ—Ä–º–∏—Ä—É–µ—Ç SetupContext JSON.
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MT5Connector.
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
   - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω–∞;
   - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤;
   - —É—Å–ø–µ—à–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ parquet;
   - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç—á—ë—Ç Prefect.
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `/logs/test_runs/`.

---

## 12. üß© –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

```python
from prefect import flow, task
from coredata.mt5_connector import run_mt5_ingest

@flow(name="BacktestFlow")
def backtest_flow():
    ctx = load_setup_context("GER40", "M15", "2025-04-01", "2025-05-31")
    result = run_mt5_ingest(ctx)
    print(result["status"], result["path"])

if __name__ == "__main__":
    backtest_flow()
```

---

## 13. üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Python 3.11+.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –≤ Windows –∏ Linux –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö.
- –õ–æ–≥–∏ –∏ –∞—Ä—Ö–∏–≤—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É—Ç–∏.
- –í—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/data/cache/`.
- –ú–æ–¥—É–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π.

---

**–ê–≤—Ç–æ—Ä:** Dreyk / ITA Engineering Team  
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä:** GPT-5 (ITA Docs Analysis Layer)  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.3 (–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
